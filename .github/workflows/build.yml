name: build
run-name: Build run ${{ github.run_number }}

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      checks: write

    steps:
      - uses: actions/checkout@v4
        with:
          # we need the full history to validate license headers
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
          server-id: github

      - name: Validate license headers
        id: validate-license-headers
        run: |
          mkdir target
          mvn -U -B validate -P sxda-license-validation 2>&1 | tee target/license-headers-validation.txt
          EXIT_CODE=${PIPESTATUS[0]}
          cat target/license-headers-validation.txt | grep -E '\[(WARNING|ERROR)\]' > target/license-headers-validation-warnings.txt
          cat target/license-headers-validation.txt | grep 'goal com.mycila:license-maven-plugin' | sed 's/^\[\([^]]*\)\] //' > target/license-headers-validation-summary.txt
          if [ $EXIT_CODE -eq 0 ] && [ ! -s target/license-headers-validation-summary.txt ]; then
            echo "No license header validation errors detected." > target/license-headers-validation-summary.txt
            echo "conclusion=success" >> $GITHUB_OUTPUT
          else
            echo "conclusion=failure" >> $GITHUB_OUTPUT
          fi
          echo "result=$(cat target/license-headers-validation-summary.txt)" >> $GITHUB_OUTPUT
          exit $EXIT_CODE

      - uses: LouisBrunner/checks-action@v1.6.1
        if: always() && github.event_name == 'pull_request'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Validate license headers
          conclusion: ${{ steps.validate-license-headers.outputs.conclusion }}
          output_text_description_file: target/license-headers-validation-warnings.txt
          output: |
            {"summary":"${{ steps.validate-license-headers.outputs.result }}"}

      - name: Build with Maven
        run: mvn -B package --file pom.xml --fail-at-end --no-transfer-progress

      - name: Create check on PR
        if: (success() || failure()) && github.event_name == 'pull_request'
        uses: scacap/action-surefire-report@v1
        with:
          report_paths: '**/surefire-reports/TEST-*.xml, **/failsafe-reports/TEST-*.xml, **/karma-reports/**/test-*.xml'
