name: build
run-name: Build run ${{ github.run_number }}

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      checks: write

    steps:
      - uses: actions/checkout@v4
        with:
          # we need the full history to validate license headers
          fetch-depth: 0

      - uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven
          server-id: github

      - name: Validate license headers
        id: validate-license-headers
        run: |
          mkdir -p target
          mvn -U -B validate -P sxda-license-validation 2>&1 | tee target/license-headers-validation.txt
          #
          # store the exit code of the mvn command and not the one of tee
          EXIT_CODE=${PIPESTATUS[0]}
          #
          # workaround, use tee to force the exit code of the next line to be 0, even if grep finds nothing and exits with 1
          grep -E '\[(WARNING|ERROR)\]' target/license-headers-validation.txt | tee target/license-headers-validation-warnings.txt
          #
          # touch to create an empty file if no warning was found
          touch target/license-headers-validation-warnings.txt
          #
          exit $EXIT_CODE

      - uses: LouisBrunner/checks-action@v1.6.1
        if: always() && github.event_name == 'pull_request'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          name: Validate license headers
          conclusion: ${{ steps.validate-license-headers.outcome }}
          output_text_description_file: target/license-headers-validation-warnings.txt
          output: |
            {"summary":"License header validation: ${{ steps.validate-license-headers.outcome }}"}

      - name: Build with Maven
        run: mvn -B package --file pom.xml --fail-at-end --no-transfer-progress

      - name: Create check on PR
        if: (success() || failure()) && github.event_name == 'pull_request'
        uses: scacap/action-surefire-report@v1
        with:
          report_paths: '**/surefire-reports/TEST-*.xml, **/failsafe-reports/TEST-*.xml, **/karma-reports/**/test-*.xml'
